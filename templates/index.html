<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSync Demo</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #000; 
            color: #fff; 
            height: 100vh; 
            justify-content: center; 
            margin: 0; 
        }
        .container { 
            text-align: center; 
            border: 1px solid #333; 
            padding: 2rem; 
            border-radius: 10px; 
            background: #111; 
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.1); 
            width: 700px; 
        }
        h1 { margin-bottom: 10px; letter-spacing: 2px; }
        #status { color: #888; font-size: 14px; margin-bottom: 15px; }
        
        .video-wrapper { 
            position: relative; 
            width: 640px; 
            height: 480px; 
            margin: 0 auto; 
            border: 2px solid #333; 
            border-radius: 8px; 
            overflow: hidden; 
            background: #000; 
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        button { 
            padding: 15px 40px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 30px; 
            border: none; 
            margin-top: 25px; 
            transition: 0.3s; 
            width: 300px;
        }
        #recordBtn { background: #333; color: #777; cursor: not-allowed; }
        #recordBtn.ready { background: #00e5ff; color: #000; cursor: pointer; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        #recordBtn.recording { background: #ff2a6d; color: white; animation: pulse 1s infinite; box-shadow: none; }
        
        #result { margin-top: 20px; font-size: 32px; font-weight: bold; color: #fff; min-height: 40px; text-transform: uppercase; }
        
        #debug { 
            font-size: 12px; 
            color: #666; 
            margin-top: 15px; 
            text-align: left; 
            font-family: 'Consolas', monospace; 
            white-space: pre-wrap; 
            background: #1a1a1a; 
            padding: 15px; 
            border-radius: 5px; 
            display: none; 
            border: 1px solid #333;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>NEURO<span style="color:#00e5ff">SYNC</span> LITE</h1>
    <div id="status">Initializing Camera...</div>
    
    <div class="video-wrapper">
        <video id="preview" autoplay playsinline muted></video>
    </div>

    <button id="recordBtn" disabled onclick="startRecording()">Wait for Camera...</button>
    
    <div id="result"></div>
    <div id="debug"></div>
</div>

<script>
    let mediaRecorder;
    let chunks = [];
    const preview = document.getElementById('preview');
    const btn = document.getElementById('recordBtn');
    const resultDiv = document.getElementById('result');
    const statusDiv = document.getElementById('status');
    const debugDiv = document.getElementById('debug');

    // 1. Initialize Camera
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 }, 
                audio: true 
            });
            
            preview.srcObject = stream;
            
            // Wait for video to actually start playing
            preview.onloadedmetadata = () => {
                preview.play();
                statusDiv.innerText = "System Ready";
                btn.innerText = "Start Analysis (5s)";
                btn.classList.add('ready');
                btn.disabled = false;
            };
        } catch (err) {
            console.error(err);
            statusDiv.innerText = "Camera Error: " + err.name;
            resultDiv.innerText = "Check Camera Permissions";
            resultDiv.style.color = "#ff2a6d";
        }
    }

    initCamera();

    function startRecording() {
        if (!preview.srcObject) return;
        
        chunks = [];
        
        // Browser Compatibility Check
        let options = { mimeType: 'video/webm;codecs=vp8,opus' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options = { mimeType: 'video/webm' }; 
        }

        try {
            mediaRecorder = new MediaRecorder(preview.srcObject, options);
        } catch (e) {
            statusDiv.innerText = "Recorder Error: " + e.message;
            return;
        }

        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstop = uploadVideo;

        // UI Updates
        btn.disabled = true;
        btn.classList.remove('ready');
        btn.classList.add('recording');
        btn.innerText = "Scanning...";
        statusDiv.innerText = "Recording 5 seconds of data...";
        resultDiv.innerText = "";
        debugDiv.style.display = "none";

        // Start Recording (Slice every 1s for safety)
        mediaRecorder.start(1000); 

        // Auto Stop logic
        setTimeout(() => {
            if (mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                statusDiv.innerText = "Processing Neural Data...";
                btn.classList.remove('recording');
                btn.innerText = "Analyzing...";
            }
        }, 5000);
    }

    async function uploadVideo() {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const formData = new FormData();
        formData.append('video', blob, 'capture.webm');

        try {
            const res = await fetch('/predict', { method: 'POST', body: formData });
            const data = await res.json();
            
            // Reset Button
            btn.innerText = "Start Analysis (5s)";
            btn.classList.add('ready');
            btn.disabled = false;
            statusDiv.innerText = "Analysis Complete";

            if(data.error) {
                resultDiv.innerText = "Error";
                debugDiv.innerText = data.error;
                debugDiv.style.display = "block";
                debugDiv.style.color = "#ff2a6d";
            } else {
                resultDiv.innerText = data.emotion;
                resultDiv.style.color = data.emotion.includes('neutral') ? '#fff' : '#00e5ff';
                
                // Show debug stats
                let debugText = `Confidence: ${data.confidence}\nSilent Audio: ${data.silent}\n\n[Class Probabilities]\n`;
                for (const [emo, score] of Object.entries(data.scores)) {
                    debugText += `${emo.padEnd(10)}: ${score}\n`;
                }
                debugDiv.innerText = debugText;
                debugDiv.style.display = "block";
                debugDiv.style.color = "#888";
            }
        } catch (e) {
            btn.disabled = false;
            btn.innerText = "Retry";
            btn.classList.add('ready');
            resultDiv.innerText = "Server Error";
            resultDiv.style.color = "#ff2a6d";
        }
    }
</script>
</body>
</html>